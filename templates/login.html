{% extends "base.html" %}

{% block title %}Login - Staff Attendance Portal{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="col-md-5">
            <div class="card shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="bi bi-calendar-check text-primary" style="font-size: 4rem;"></i>
                        <h2 class="mt-3">Staff Login</h2>
                        <p class="text-muted">Sign in to mark your attendance</p>
                    </div>
                    
                    <form method="POST" action="{{ url_for('login') }}">
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i class="bi bi-envelope"></i> Email Address
                            </label>
                            <input type="email" class="form-control form-control-lg" id="email" 
                                   name="email" placeholder="Enter your email" required autofocus>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="bi bi-lock"></i> Password
                            </label>
                            <input type="password" class="form-control form-control-lg" id="password" 
                                   name="password" placeholder="Enter your password" required>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="remember" name="remember">
                            <label class="form-check-label" for="remember">
                                Remember me
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-box-arrow-in-right"></i> Sign In
                        </button>
                    </form>
                    
                    <hr class="my-4">
                    
                    <!-- Fingerprint Authentication -->
                    <div id="fingerprint-section" class="text-center">
                        <p class="text-muted mb-2">Or sign in with</p>
                        <button type="button" class="btn btn-outline-primary btn-lg w-100" id="fingerprint-login-btn" 
                                onclick="handleFingerprintLogin()">
                            <i class="bi bi-fingerprint"></i> Use Fingerprint
                        </button>
                        <div id="fingerprint-status" class="mt-2"></div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <p class="mb-0">Don't have an account? 
                            <a href="{{ url_for('signup') }}" class="text-decoration-none">
                                <strong>Sign Up</strong>
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Your login time will be automatically recorded
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Helper function to convert base64url to base64
function base64urlToBase64(base64url) {
    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    while (base64.length % 4) {
        base64 += '=';
    }
    return base64;
}

// Helper function to convert base64 to base64url
function base64ToBase64url(base64) {
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

async function handleFingerprintLogin() {
    const emailInput = document.getElementById('email');
    const email = emailInput.value.trim().toLowerCase();
    
    if (!email) {
        showFingerprintStatus('Please enter your email first', 'danger');
        emailInput.focus();
        return;
    }
    
    const statusDiv = document.getElementById('fingerprint-status');
    const btn = document.getElementById('fingerprint-login-btn');
    
    // Check if WebAuthn is supported
    if (!window.PublicKeyCredential) {
        showFingerprintStatus('Fingerprint authentication is not supported in this browser/device.', 'warning');
        return;
    }
    
    try {
        btn.disabled = true;
        showFingerprintStatus('Requesting authentication...', 'info');
        
        // Get authentication options
        const optionsResponse = await fetch('/webauthn/login/options', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });
        
        const optionsData = await optionsResponse.json();
        
        if (!optionsResponse.ok) {
            showFingerprintStatus(optionsData.error || 'Authentication not available for this user', 'warning');
            btn.disabled = false;
            return;
        }
        
        // Convert challenge to ArrayBuffer
        const challenge = Uint8Array.from(atob(base64urlToBase64(optionsData.challenge)), c => c.charCodeAt(0));
        
        // Convert credential IDs
        const allowCredentials = optionsData.allowCredentials.map(cred => ({
            ...cred,
            id: Uint8Array.from(atob(base64urlToBase64(cred.id)), c => c.charCodeAt(0))
        }));
        
        const publicKeyCredentialRequestOptions = {
            challenge: challenge,
            allowCredentials: allowCredentials,
            rpId: optionsData.rpId,
            userVerification: 'required',
            timeout: 60000
        };
        
        showFingerprintStatus('Please use your fingerprint to authenticate...', 'info');
        
        // Request authentication
        const credential = await navigator.credentials.get({
            publicKey: publicKeyCredentialRequestOptions
        });
        
        // Convert response to base64url
        const response = {
            id: base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))),
            rawId: base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))),
            type: credential.type,
            response: {
                authenticatorData: base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.response.authenticatorData)))),
                clientDataJSON: base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON)))),
                signature: base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.response.signature)))),
                userHandle: credential.response.userHandle ? base64ToBase64url(btoa(String.fromCharCode(...new Uint8Array(credential.response.userHandle)))) : null
            }
        };
        
        // Verify authentication
        const verifyResponse = await fetch('/webauthn/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                credential: response
            })
        });
        
        const verifyData = await verifyResponse.json();
        
        if (verifyResponse.ok && verifyData.success) {
            showFingerprintStatus('âœ“ Authentication successful! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = verifyData.redirect;
            }, 1000);
        } else {
            showFingerprintStatus(verifyData.error || 'Authentication failed. Please try again.', 'danger');
            btn.disabled = false;
        }
        
    } catch (error) {
        console.error('Fingerprint authentication error:', error);
        if (error.name === 'NotAllowedError') {
            showFingerprintStatus('Authentication cancelled or not available.', 'warning');
        } else if (error.name === 'InvalidStateError') {
            showFingerprintStatus('No fingerprint registered for this account. Please use password login.', 'warning');
        } else {
            showFingerprintStatus('Authentication error: ' + error.message, 'danger');
        }
        btn.disabled = false;
    }
}

function showFingerprintStatus(message, type) {
    const statusDiv = document.getElementById('fingerprint-status');
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    statusDiv.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}
</script>
{% endblock %}




